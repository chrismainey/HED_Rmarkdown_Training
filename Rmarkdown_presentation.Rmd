---
title: "R Markdown"
author: "Chris Mainey chris.mainey@uhb.nhs.uk"
date: "2020/01/10 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: "libs/HED.css"
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: center, middle

<br><br><br><br><br><br>

# Introduction to `Rmarkdown`

<br>

__Chris Mainey__

<a href="mailto:chris.mainey@uhb.nhs.uk">chris.mainey@uhb.nhs.uk</a>

<br><br>
2020-01-20 (updated: `r Sys.Date()`)
<br><br><br><br><br><br>
<span style="font-size:14px !important;"> __&copy; Healthcare Evaluation Data (HED)__- part of Health Informatics, University Hospitals Birmingham NHS Foundation Trust.  
<b>NOT TO BE REPUBLISHED OR DISTRIBUTED WITHOUT CONSENT</b> </span>

---

# RStudio Cloud

We are using RStudio cloud for this course.

+ Browser-based RStudio session
+ All materials are pre-loaded
+ Material will be available on GitHub afterwards for two weeks
+ We will send round details after the course

<br><br>
### Please got to the following link and register for the workspace:
# https://bit.ly/34ntbTx


---

# Course Content

- What is `R` markdown?
- Structure
- Formats
- Output types
 - HTML & CSS
 - PDF / Latex
 - MS Office
- Parametrisation
 - Including and using prarmeters
 - Automating reports

_(Plus coffee, and lunch, of course...)_
---

## What is it?

<img src="https://github.com/allisonhorst/stats-illustrations/blob/master/rstats-artwork/rmarkdown_rockstar.png?raw=true" width="500" class="center">

<div style="text-align: center;"> <span style="font-size: 14px;"> Artwork by <b>@allison_horst</b></span></div>

<br>


Much of our intro section is based on: __R Markdown: The Definitive Guide__ by _Yihui Xie, J. J. Allaire, Garrett Grolemund_
https://bookdown.org/yihui/rmarkdown/

---

# What is Rmarkdown

`Markdown` (.md) is a common free-text format.  
- Originally by 
[John Gruber](https://daringfireball.net/projects/markdown/), simple communication medium for writers
- Text to HTML tool
- Initially limited syntax, but signficantly enriched over time

--

`Pandoc`
- Written by [John McFarlane](http://pandoc.org/), a universal document converter
- Allows markdown to be parsed to other formats like Latex, with powerful formatting
- Latex can then be converted to PDF and others

--

`Rmarkdown`
- Created by Yihui Xie, to embed code chunks in markdown
- Expanded to include fine control of elements
- Intergrated in RStudio environment
- Lots of extensions 


---


# Why would I want to use it?

You can write a single document with all your text, code and graphics in the same place.
<br>
It could also be used as a final report, teaching material, blog post etc.

.pull-left[
### Advantages:
+ Collaborate and share well-formatted reports, or notebooks.
+ Write your documentaion as you go.
+ Reproducible
+ Can be used as both scripts and final reports (and more...)
+ Can be parameterised to build regular reports / multiple versions of outputs.
]

.pull-right[
### Challenges
+ Requires some `R` knowledge
+ Output formats can be tricky, particularly with PDF
+ Works best if shared.  Difficult if lone analyst using it.

]




--

<br>
This course pairs well with the free ebook __R Markdown: The Definitive Guide__ by _Yihui Xie, J. J. Allaire, Garrett Grolemund_
https://bookdown.org/yihui/rmarkdown/


---

## Software (available for free)

+ `R`

--

+ RStudio

--

## R Packages (available for free on CRAN)

+ rmarkdown

--

+ tidyverse

--

+ xaringan

--

+ ggplot2

--

+ DT

---

# Document Structure

Markdown documents are composed of three main elements:

+ Metadata
+ Text
+ Code

--

<br>
Other elements, depending on the output, might be:
+ CSS files
+ javascript
+ html 'widgets'
+ Shiny apps

---

# Metadata: YAML

The metadata of a markdown file is the first thing you see at the top of the document.  

+ It sets properties like document name, author but also functional elements like:
  + File locations
  + Output formats (HTML, PDF, Word etc.)
  + Styling elements, including CSS
--
<br><br>
+ It is written in __YAML__ - ('YAML Ain't Markup Language') [Wikipedia article](https://en.wikipedia.org/wiki/YAML)
  - Reference: https://bookdown.org/yihui/bookdown/yaml-options.html
  
```yaml
---
title: "An introduction to Rmarkdown"
author: "Chris Mainey"
date: "16/05/2019"
output: 
  html_doucment
  word_document
bibliography: references.bib
---
```

---

# Text

Free-text is treated as such, and coded as a paragraph `<p>` element in HTML.  Other formatting is achieved using special characters, pandoc, HTML etc.

--

.pull-left[

```text

+ Bullet 1

  + Bullet 2






# Heading 1





## Heading 2



### Heading 3



_italic_ and __bold__


[BBC News](www.bbc.co.uk/news)
```
]


.pull-right[
+ Bullet 1
  + Bullet 2

# Heading 1
## Heading 2
### Heading 3

_italic_ and __bold__

[BBC News](www.bbc.co.uk/news)
]

---
class: left, middle

# Exercise 1: 
## Build an `Rmarkdown` document from template

+ Use the `File` menu to create a new R Markdown document
+ Read through it and see the formatting
+ 'knit' the document together, using the `knitr` package, button at the top
+ Look at the output

---

# Code Chunks (1)

Blocks of code in R, SQL, Python and other languages can be run as part of the document in __chunks__.
The result of the code can be shown on its own, with the code chunk or not at all.

--

```{r plotexample, fig.align='center', fig.height=4.3, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2)
data(mtcars)
ggplot(mtcars, aes(x=mpg))+
  geom_histogram(col=1,fill="orange", alpha=0.75,bins=10)+
  ggtitle("Miles per gallon (mpg) of cars in 'mtcars' dataset")

```


---

# Code Chunks (2)

Start and end code chunks with three backticks 

The last section looked like this:

<img src= 'Assets/code-chunk-header-1.PNG' width=100%>

The chunk header is inside {curly brackets}. We gave it the language (r), a name for the chunk ('plotexample'), 
turned warnings and messages off, and set options for figure alignment and size.

<br>
Import, clean and process data, then produce the figure all in one place.

---

# Chunk Options

There are a lot of options for code chunks, but here are some of the important ones:
+ eval=FALSE -  __Don't evaluate/run the code block__
+ echo=FALSE -  __Don't display the code block__
+ include=FALSE -  __Run the code but don't include in final document__
+ collapse = TRUE -  __Merge the code and all outputs into a single chunk for display__
+ message = FALSE - __Don't print messages generated by the code__
+ warning = FALSE - __Don't print errors generated by the code__

<br>

Can also be changed in RStudio by clicking on the cog in the top right of the code chunk

<img src= 'Assets/code-chunk-header-1.PNG' width=100%>

---
class: left, middle

# Exercise 2: 
### Build a parametrised `Rmarkdown` using `LOS_model`
#### Part (a)
+ Create a new markdown document or clear your last one.
+ In this document, please do the following:
 + Create a hidden code block that loads the LOS_model data
 + Add some titles and text to explain what is happening
 + Add a hyper-link to the `NHSRdataset` package (find it via Google)
 + Add a code block using `dplyr` to summarise the `mean` and `median` LOS
 + Create a histogram of the LOS

---

# Inline Code

Code can be run within the text by surrounding it with <code>&#96;r &#96;</code>

<br>

Insert numeric values and change the text with conditional statements

<br>

--

.pull-left[
The sum of 4 and 5 is <code>&#96;r 4+5&#96;</code>

<br>

4 is <code>&#96;r if(4>5){"greater than"} else {"less than"}&#96;</code> 5
]

.pull-right[
&rarr; The sum of 4 and 5 is `r 4+5`

<br>

&rarr; 4 is `r if(4>5){"greater than"} else {"less than"}` than 5
]

---

# knitr

<img src="https://github.com/allisonhorst/stats-illustrations/blob/master/rstats-artwork/rmarkdown_wizards.png" width="500">


https://yihui.org/knitr/


---
class middle, left

# Formatting R markdown documents

---

# Blah

You want to make it look nice....


---


# Kable

+ Kable is an R package that allows for advanced table formatting
+ 'Standard' views of tables can be dull without any styling applied
+ Kable code is simple and allows for easy, pleasurable output

``` {r, include=TRUE, echo=TRUE, warning =FALSE}
library(NHSRdatasets)
data("LOS_model")
LOS_summary <- (summary(LOS_model))
library(kableExtra)
dt <-  LOS_model
head(dt) %>%    # Only shows the first 6 lines of the table
  kable %>% 
  kable_styling()   # Applies the 'Twitter' bootstrap styling
```

---

# More Kable

``` {r, include=TRUE, echo=TRUE, warning =FALSE}

dt[1:2, 1:5] %>%    
  kable %>% 
            # The additional parameters in the line below adds striping to the table and stops
            # it from spreading across the full page (this is overridden by our CSS file)
  kable_styling(bootstrap_options="striped", full_width = F) 
  

```

## Activity 

+ Convert a table that you have already loaded into R into Kable format.  
+ You can use the example I have shown and stick to the same styling or experiment with other Kable options
+ Look at the vignette -`vignette("awesome_table_in_html")`

---


# HTML Tables with `DT`

Creates HTML tables from R data frames and includes filters, searching and pagination

Can be used in interactive Rmarkdown documents, shiny apps and html outputs

```{r using_DT, message=FALSE, warning=FALSE}
library(NHSRdatasets)
library(DT)
data(LOS_model)

datatable(LOS_model, options = list(pageLength = 5))
```

---

# Tables with `flextable`

```{r using_flextable_shown, message=FALSE, warning=FALSE, eval=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(head(LOS_model))

flextable(data = (LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c(1,4)) %>% # merge the Organisation and Death columns
  valign(j = c(1,4),valign = "top") # move the merged column entries to the top
```

.pull-left[
+ Creates well formatted tables that will render in html, pdf, Word and Powerpoint.
+ Can also 'plot' the tables as images
+ Excellent range of formatting options including fonts, borders, merging, cell sizes, etc.
]

.pull-right[

```{r using_flextable_hidden, message=FALSE, warning=FALSE, echo=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(LOS_model)

flextable(data = LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c("Organisation", "Death")) %>% # merge the Organisation and Death columns
  valign(j = c("Organisation", "Death"),valign = "top") # move the merged column entries to the top
```

]
---
class: middle, left

# Output Styles

---

Anthony

---
# HTML Tables with `DT`

The DT package creates HTML tables from R data frames and includes filters, searching and pagination

Can be used in interactive Rmarkdown documents, shiny apps and html outputs

```{r using_DT, message=FALSE, warning=FALSE}
library(NHSRdatasets)
library(DT)
data(LOS_model)

datatable(LOS_model, options = list(pageLength = 5))
```

---

# Tables with `flextable`

```{r using_flextable_shown, message=FALSE, warning=FALSE, eval=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(LOS_model)

flextable(data = LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c(1,4)) %>% # merge the Organisation and Death columns
  valign(j = c(1,4),valign = "top") # move the merged column entries to the top
```

.pull-left[
+ Creates well formatted tables that will render in html, pdf, Word and Powerpoint.
+ Can also 'plot' the tables as images
+ Excellent range of formatting options including fonts, borders, merging, cell sizes, etc.
]

.pull-right[
```{r using_flextable_hidden, message=FALSE, warning=FALSE, echo=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(LOS_model)

flextable(data = LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c("Organisation", "Death")) %>% # merge the Organisation and Death columns
  valign(j = c("Organisation", "Death"),valign = "top") # move the merged column entries to the top
```
]

---

# HTML & CSS

---

# Easy styling of Markdown

+ Whilst CSS and HTML are powerful and allow you to fully customise your document, it can be quite time consuming if all you want to do is apply a straight forward theme
+ This is where the 'themes' section comes in - it allows you to automatically produce themed Markdown documents based on the use of a single word e.g. 'striped', 'sandstone'
+ This removes the need to add in all of the CSS coding you have done if you want a generically applied theme

``` {eval = FALSE}
---
title: Trust evaluation of LOS_model
output:
  html_document:
    theme:united
---  
```

By adding the above `theme:united` section of code into the YAML header, you can instantly apply the theme.  Let's see what this does.

---

# Applying themes

<figure>
  <p><img src= "./Assets/themes_output.png"
  width= 50% height=50%
  class="center"
    alt="Theme output">
  <figcaption> How the 'united' theme appears on output </figcaption>
</figure>

--

## Activity 
<br>
+ Try out a theme on your Markdown file instead of using CSS
+ Use the example on the previous slide to see how to do it
+ Remember to comment / hashtag out your CSS file reference in the YAML header


---

class: middle, left

# Lunch

---

# Recap


---
# Using R markdown with Office


---

# Parameters:

Here's where it gets even more useful.  If you have a report that you need to repeat many times, you might want to use 'parameters'.

+ You may want to:
  + Run daily reports for different wards / gp practises
  + Change the key measure of a standard report
  + Change report dates etc.

--

You add parameters to your YAML header:

```{r yaml2, eval=FALSE}
---
title: "An introduction to Rmarkdown"
author: "Chris Mainey"
date: "16/05/2019"
output: 
  html_document
params: #<<
  Trust: "Trust1" #<<
---
```
--

+ ...then refer to them as if in a data.frame: `params$Trust`

---

# Exercise 2: 
### Build a parametrised `Rmarkdown` using `LOS_model`
#### Part (b)

 + Add a horizontal rule 
 + Do the same as part (a) for a single trust
 + Use a parameter to select the trust
 + Change the title of the last section to include the name of the trust
 + Add a sentence at the end that says
    
    &#60;Trust Name&#62; has a length of stay which is &#60;shorter/longer&#62; than average

---

# Creating a batch

It is possible to generate each report by manually changing the parameters in the YAML header. But that is slow.

Create reports with different parameters using a `for` loop and the `render` function.

``` {r batch_reporting, eval = FALSE}

trusts <- c("trust1", "trust 2", "etc...")

for(trust_name in trusts){
  rmarkdown::render(input = "my_report.Rmd"
                    , output_file = file.path("report_batch"
                                              , paste("my_report_"
                                                      , trust_name
                                                      , sep = ""
                                                      )
                                              )
                    , params = list(Trust = trust_name) #<<
                    )
}
```

This will create a report for each trust in the `trusts` vector

The `params` argument must be in the format of a _named list_

Values in `params` will override values in the YAML header, but will keep any other values there.

Change the output file name or it will keep overwriting the same file!

---

# Exercise 3: 
### Create a batch of reports

+ Use a `for` loop inside an `Rmarkdown` document to build the report from the previous exercise for __all 10 trusts__ in the LOS_model data.

---

# Fancier Stuff

There are lots of fancier things you can do, some of which require plugins, HTML or CSS but many don't.

.pull-left[
+ Flextable
+ MathJax
+ LaTeX
+ Footnotes and annotations
+ BibTeX Bibliographies (including integration with zotero etc.)
+ `htmlWidgets` like interactive maps, paginated tables with filters
+ Shiny documents
+ Powerpoint and Word templates

]

.pull-right[
<br>
<a href="https://imgflip.com/i/30tnps"><img src="https://i.imgflip.com/30tnps.jpg" title="made at imgflip.com" width=100%/></a>
]


---

# Shiny Apps

Shiny apps can be included in an Rmarkdown document to make it interactive

<br>

Rmarkdown documents can be served by a Shiny Server to make accessing them as simple as following a link

<br>

Congratulations, you are now a web developer!

---


# Leaflet package

``` {r}

library(leaflet)

m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=-1.93917290996, lat=52.4510115293, popup="QE Hospital, Birmingham") # This uses the 'decimal degrees' measurement of longitude and latitude

m
```

---

# Using leaflet with purpose

+ By using the `LOS_model` that we have been using today, you could produce 'heat maps'or similar concepts to represent a distribution of data
+ I will add in a small, additional data frame with some longitude 
+ You could then use something like this to identify where there may be patterns


``` {r echo=FALSE}

latitude <-  c(52.47819,52.48372,52.4790)

longitude <-  c(-1.89984,-1.89837,-1.8925)

df <- data.frame(latitude,longitude)

m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(data=df,lat= ~latitude,lng= ~longitude, popup="Cardiology patients with LOS above 4 days in the Birmingham area") # This uses the 'decimal degrees' measurement of longitude and latitude

m


```

---


---

# Rmarkdown tips

+ Check the 'options' via the tools menu and check you are using `knitr` not `sweave`
+ You can `knit` to PDF or Word easily, but may need to install additional packages
+ You may need Latex installed on Windows, I use Miktex or `tinytex`
+ You can control lots of stuff using the YAML or chunk options
+ You can use CCS to style outputs consistently
+ You can write presentations, e.g. this is using `rmakrdown` with `xaringan`
+ Other extension include `blogdown`, `bookdown`, `thesisdown` and many others
+ You can use with reference managers, e.g. Endnote or Zotero, using BibTeX


---

# Thanks!

`r icon::fa("envelope", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="mailto:hed@uhb.nhs.uk;" style="line-height:2;"> hed@uhb.nhs.uk </a>
<br>
`r icon::fa("globe", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="http://www.hed.nhs.uk" style="line-height:2;">http://www.hed.nhs.uk</a>
<br>
<br>
<br>
`r icon::fa("envelope", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="mailto:chris.mainey@uhb.nhs.uk;" style="line-height:2;"> chris.mainey@uhb.nhs.uk </a>
<br>
`r icon::fa("twitter", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="https://twitter.com/chrismainey?s=09" style="line-height:2;">@chrismainey</a>
<br>
`r icon::fa("github", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="https://github.com/chrismainey)" style="line-height:2;">chrismainey</a>
<br>
`r icon::fa("globe", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="http://www.mainard.co.uk" style="line-height:2;">http://www.mainard.co.uk</a>
<br>
<br>
<img src= 'Assets/funnelplotr.png' width=10% height=10% align="middle"> `FunnelPlotR`  `r icon::fa("box")`  now available on CRAN!



---
title: "R Markdown"
author: "Chris Mainey chris.mainey@uhb.nhs.uk"
date: "2020/01/10 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: "libs/HED.css"
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: center, middle

<br><br><br><br><br><br>
# Introduction to `Rmarkdown`

<br>

__Chris Mainey__

<a href="mailto:chris.mainey@uhb.nhs.uk">chris.mainey@uhb.nhs.uk</a>

<br><br>
2020-01-20 (updated: `r Sys.Date()`)
<br><br><br><br><br><br>
<span style="font-size:14px !important;"> __&copy; Healthcare Evaluation Data (HED)__- part of Health Informatics, University Hospitals Birmingham NHS Foundation Trust.  
<b>NOT TO BE REPUBLISHED OR DISTRIBUTED WITHOUT CONSENT</b> </span>

---

# RStudio Cloud

We are using RStudio cloud for this course.

+ Browser-based RStudio session
+ All materials are pre-loaded
+ Material will be available on GitHub afterwards for two weeks
+ We will send round details after the course

<br><br>
### Please got to the following link and register for the workspace:
# https://bit.ly/34ntbTx


---

# Summary

__Morning__

- What is Rmarkdown
- Software & Packages
- Document Structure
- RMarkdown Syntax

<br>

__Afternoon__

- Code Chunks
- Inline Code
- Parameters
- Generating multiple reports
- DT Tables
- Flex Tables
- Shiny Apps

---
class: middle

# Rmarkdown: 
### Documentation, Notebooks, and Reporting Structures in `R`


---

# What is Rmarkdown

`Markdown` (.md) is a common free-text format.  It can be used to write documents then mark the various different sections, formats etc.

--

<br>

`Rmarkdown` is an `R`-specific flavour that adds `R` code into the `Markdown` paradigm.  You can write a document that runs code, chose whether to show this code at the output, and then render it to various output formats.

--

<br>
Can `knit` to HTML, PDF, Word and more, all from a single `Rmarkdown` file using the `knitr` package.

--

<br>
Allows you to collaborate and share your code in well formatted reports, or notebooks.

--

<br>
It could also be used as a final report, teaching material, blog post etc.

--

<br>
Can be parameterised to provide standard/regular reports controlled by parameters like date, or specialty code.

<br>
This course pairs well with the free ebook __R Markdown: The Definitive Guide__ by _Yihui Xie, J. J. Allaire, Garrett Grolemund_
https://bookdown.org/yihui/rmarkdown/

---

## Software (available for free)

+ `R`

--

+ RStudio

--

## R Packages (available for free on CRAN)

+ rmarkdown

--

+ tidyverse

--

+ xaringan

--

+ ggplot

--

+ DT

--

+ flextable

--

+ redoc

---

# Document Structure

Markdown documents are composed of three main elements:

+ Metadata
+ Text
+ Code

--

<br>
Other elements, depending on the output, might be:
+ CSS files
+ javascript
+ html 'widgets'
+ Shiny apps

---

# Metadata: YAML

The metadata of a markdown file is the first thing you see at the top of the document.  

+ It sets properties like document name, author but also functional elements like:
  + File locations
  + Output formats (HTML, PDF, Word etc.)
  + Styling elements, including CSS
--
<br><br>
+ It is written in __YAML__ - ('YAML Ain't Markup Language') [Wikipedia article](https://en.wikipedia.org/wiki/YAML)
  - Reference: https://bookdown.org/yihui/bookdown/yaml-options.html
  
```yaml
---
title: "An introduction to Rmarkdown"
author: "Chris Mainey"
date: "16/05/2019"
output: 
  html_doucment
  word_document
bibliography: references.bib
---
```

---

# Text

Free-text is treated as such, and coded as a paragraph `<p>` element in HTML.  Other formatting is achieved using special characters, pandoc, HTML etc.

--

.pull-left[

```text

+ Bullet 1

  + Bullet 2






# Heading 1





## Heading 2



### Heading 3



_italic_ and __bold__


[BBC News](www.bbc.co.uk/news)
```
]


.pull-right[
+ Bullet 1
  + Bullet 2

# Heading 1
## Heading 2
### Heading 3

_italic_ and __bold__

[BBC News](www.bbc.co.uk/news)
]

---

class: left, middle


# Exercise 1: 
## Build an `Rmarkdown` document from template

+ Use the `File` menu to create a new R Markdown document
+ Read through it and see the formatting
+ 'knit' the document together, using the `knitr` package, button at the top
+ Look at the output

---

# Code Chunks

Blocks of code in R, SQL, Python and other languages can be run as part of the document in __chunks__.
The result of the code can be shown on its own, with the code chunk or not at all.

--

```{r plotexample, fig.align='center', fig.height=4.3, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2)
data(mtcars)
ggplot(mtcars, aes(x=mpg))+
  geom_histogram(col=1,fill="orange", alpha=0.75,bins=10)+
  ggtitle("Miles per gallon (mpg) of cars in 'mtcars' dataset")

```


---

# Code Chunks (2)

Start and end code chunks with three backticks 

The last section looked like this:

<img src= 'Assets/code-chunk-header-1.PNG' width=100%>

The chunk header is inside {curly brackets}. We gave it the language (r), a name for the chunk ('plotexample'), 
turned warnings and messages off, and set options for figure alignment and size.

<br>
Import, clean and process data, then produce the figure all in one place.

---

# Chunk Options

There are a lot of options for code chunks, but here are some of the important ones:
+ eval=FALSE -  __Don't evaluate/run the code block__
+ echo=FALSE -  __Don't display the code block__
+ include=FALSE -  __Run the code but don't include in final document__
+ collapse = TRUE -  __Merge the code and all outputs into a single chunk for display__
+ message = FALSE - __Don't print messages generated by the code__
+ warning = FALSE - __Don't print errors generated by the code__

<br>

Can also be changed in RStudio by clicking on the cog in the top right of the code chunk

<img src= 'Assets/code-chunk-header-1.PNG' width=100%>

---

# Exercise 2: 
### Build a parametrised `Rmarkdown` using `LOS_model`
#### Part (a)
+ Create a new markdown document or clear your last one.
+ In this document, please do the following:
 + Create a hidden code block that loads the LOS_model data
 + Add some titles and text to explain what is happening
 + Add a hyper-link to the `NHSRdataset` package (find it via Google)
 + Add a code block using `dplyr` to summarise the `mean` and `median` LOS
 + Create a histogram of the LOS

---

# Inline Code

Code can be run within the text by surrounding it with <code>&#96;r &#96;</code>

<br>

Insert numeric values and change the text with conditional statements

<br>

--

.pull-left[
The sum of 4 and 5 is <code>&#96;r 4+5&#96;</code>

<br>

4 is <code>&#96;r if(4>5){"greater than"} else {"less than"}&#96;</code> 5
]

.pull-right[
&rarr; The sum of 4 and 5 is `r 4+5`

<br>

&rarr; 4 is `r if(4>5){"greater than"} else {"less than"}` than 5
]

---

# Rmarkdown Output Formats

+ HTML

--

+ PDF

--

+ PowerPoint
+ Word

---

# Word Documents

.pull-left[
+ Available by default
+ Not all features will work in the Word file (e.g. interactive figures)
+ Uses Word styles to format content
]

.pull-right[
<img src='Assets/make_new_word_doc.png'>
]

---

# Customising Word Documents

+ Provide a 'style guide' .docx file in the YAML header

--

```{r yaml_word, eval = FALSE}
---
title: "Word Report"
author: "J. Smith"
date: "01-01-2000"
output:
  word_document:
    reference_docx: style-guide.docx #<<
---
```

--

+ File content doesn't matter, just the styles

--

+ Create one by making a new Word file with Rmarkdown
+ Copy it and call it something helpful ('style-guide.docx')
+ Open in Word and change the **styles**

--

+ Save it and make it the reference_docx in the YAML

---

# Redoc: Word and Rmarkdown in the same file

+ Experimental
+ Creates Word documents with the raw Rmarkdown hidden inside
+ Keeps comments and changes made in Word
+ Can be converted back into Rmarkdown to work on it again

---

# Parameters:

Here's where it gets even more useful.  If you have a report that you need to repeat many times, you might want to use 'parameters'.

+ You may want to:
  + Run daily reports for different wards / gp practises
  + Change the key measure of a standard report
  + Change report dates etc.

--

You add parameters to your YAML header:

```{r yaml2, eval=FALSE}
---
title: "An introduction to Rmarkdown"
author: "Chris Mainey"
date: "16/05/2019"
output: 
  html_document
params: #<<
  Trust: "Trust1" #<<
---
```
--

+ ...then refer to them as if in a data.frame: `params$Trust`

---

# Exercise 2: 
### Build a parametrised `Rmarkdown` using `LOS_model`
#### Part (b)

 + Add a horizontal rule 
 + Do the same as part (a) for a single trust
 + Use a parameter to select the trust
 + Change the title of the last section to include the name of the trust
 + Add a sentence at the end that says
    
    &#60;Trust Name&#62; has a length of stay which is &#60;shorter/longer&#62; than average

---

# Creating a batch

It is possible to generate each report by manually changing the parameters in the YAML header. But that is slow.

Create reports with different parameters using a `for` loop and the `render` function.

``` {r batch_reporting, eval = FALSE}

trusts <- c("trust1", "trust 2", "etc...")

for(trust_name in trusts){
  rmarkdown::render(input = "my_report.Rmd"
                    , output_file = file.path("report_batch"
                                              , paste("my_report_"
                                                      , trust_name
                                                      , sep = ""
                                                      )
                                              )
                    , params = list(Trust = trust_name) #<<
                    )
}
```

This will create a report for each trust in the `trusts` vector

The `params` argument must be in the format of a _named list_

Values in `params` will override values in the YAML header, but will keep any other values there.

Change the output file name or it will keep overwriting the same file!

---

# Exercise 3: 
### Create a batch of reports

+ Use a `for` loop inside an `Rmarkdown` document to build the report from the previous exercise for __all 10 trusts__ in the LOS_model data.

---

# Fancier Stuff

There are lots of fancier things you can do, some of which require plugins, HTML or CSS but many don't.

.pull-left[
+ Flextable
+ MathJax
+ LaTeX
+ Footnotes and annotations
+ BibTeX Bibliographies (including integration with zotero etc.)
+ `htmlWidgets` like interactive maps, paginated tables with filters
+ Shiny documents
+ Powerpoint and Word templates

]

.pull-right[
<br>
<a href="https://imgflip.com/i/30tnps"><img src="https://i.imgflip.com/30tnps.jpg" title="made at imgflip.com" width=100%/></a>
]
---

# HTML Tables with `DT`

Creates HTML tables from R data frames and includes filters, searching and pagination

Can be used in interactive Rmarkdown documents, shiny apps and html outputs

```{r using_DT, message=FALSE, warning=FALSE}
library(NHSRdatasets)
library(DT)
data(LOS_model)

datatable(LOS_model, options = list(pageLength = 5))
```

---

# Tables with `flextable`

```{r using_flextable_shown, message=FALSE, warning=FALSE, eval=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(LOS_model)

flextable(data = LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c(1,4)) %>% # merge the Organisation and Death columns
  valign(j = c(1,4),valign = "top") # move the merged column entries to the top
```

.pull-left[
+ Creates well formatted tables that will render in html, pdf, Word and Powerpoint.
+ Can also 'plot' the tables as images
+ Excellent range of formatting options including fonts, borders, merging, cell sizes, etc.
]

.pull-right[

```{r using_flextable_hidden, message=FALSE, warning=FALSE, echo=FALSE}
library(NHSRdatasets)
library(flextable)
library(dplyr) # for %>% and arrange()
data(LOS_model)

flextable(data = LOS_model %>% arrange(Organisation, Death, ID) #order the data
          , col_keys = c("Organisation", "Age", "LOS", "Death") #display these columns (not ID)
          ) %>%
  merge_v(j = c("Organisation", "Death")) %>% # merge the Organisation and Death columns
  valign(j = c("Organisation", "Death"),valign = "top") # move the merged column entries to the top
```

]

---

# Shiny Apps

Shiny apps can be included in an Rmarkdown document to make it interactive

<br>

Rmarkdown documents can be served by a Shiny Server to make accessing them as simple as following a link

<br>

Congratulations, you are now a web developer.

---

# Rmarkdown tips

+ Check the 'options' via the tools menu and check you are using `knitr` not `sweave`
+ You can `knit` to PDF or Word easily, but may need to install additional packages
+ You may need Latex installed on Windows, I use Miktex or `tinytex`
+ You can control lots of stuff using the YAML or chunk options
+ You can use CCS to style outputs consistently
+ You can write presentations, e.g. this is using `rmakrdown` with `xaringan`
+ Other extension include `blogdown`, `bookdown`, `thesisdown` and many others
+ You can use with reference managers, e.g. Endnote or Zotero, using BibTeX


---

# Thanks!

`r icon::fa("envelope", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="mailto:hed@uhb.nhs.uk;" style="line-height:2;"> hed@uhb.nhs.uk </a>
<br>
`r icon::fa("globe", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="http://www.hed.nhs.uk" style="line-height:2;">http://www.hed.nhs.uk</a>
<br>
<br>
<br>
`r icon::fa("envelope", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="mailto:chris.mainey@uhb.nhs.uk;" style="line-height:2;"> chris.mainey@uhb.nhs.uk </a>
<br>
`r icon::fa("twitter", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="https://twitter.com/chrismainey?s=09" style="line-height:2;">@chrismainey</a>
<br>
`r icon::fa("github", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="https://github.com/chrismainey)" style="line-height:2;">chrismainey</a>
<br>
`r icon::fa("globe", color=rgb(148, 198, 0, maxColorValue = 255))` <a href="http://www.mainard.co.uk" style="line-height:2;">http://www.mainard.co.uk</a>
<br>
<br>
<img src= 'Assets/funnelplotr.png' width=10% height=10% align="middle"> `FunnelPlotR`  `r icon::fa("box")`  now available on CRAN!


